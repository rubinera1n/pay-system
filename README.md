# 支付系统架构

1. **架构的定义**：架构一定是基于业务功能来展开的，主要是制定技术规范、框架，指导系统落地，好的架构是需要不断演变和进化而来的。
2. **架构需要关注的基础核心点主要是**：安全、稳定、可扩展。
3. **构建架构时需要关注的点**：目标客户是谁、主要场景有哪些、流程是怎样的、模型、职责有哪些、边界在哪里以及设计。其中比较难以理解的点是困难及模型这两块。
4. **架构与业务需求的关系**：架构的产生来自于业务需求，业务需求进一步抽象形成架构，架构指导后续研发，研发最终成果解决业务需求的问题。整体是一个正向循环的关系。

## 一、支付架构

![img](https://heuristic-nightingale-6c42ab.netlify.app/img/pay_architecture.jpg)

## 二、支付流程分析

![img](https://heuristic-nightingale-6c42ab.netlify.app/img/pay_flow.jpg)

一般渠道是采用**异步通知**方法来通知商户是否支付成功。

### 对接渠道可能会遇到的问题
- 接口文档升级、变更能及时得到通知；
- 有些业务没有异步通知；
- 同一业务在不同渠道表现不一样；
- 各种渠道的各自异常。

### 商户的要求
- 清晰的 API 、SDK 文档；
- 安全；
- 所有应用接口统一标准的异步通知；
- 保证出口 IP 稳定（安全）。

### 在系统架构设计时需要注意的一些要点：
- 提供规范的 API、SDK；
- 安全（通讯安全、数据安全）；
- 稳定；
- 异步通知统一；
- 各渠道的异常；
- 及时了解渠道接口调整。

## 三、支付核心逻辑

### 支付逻辑
主要是根据请求的参数进行静态检验和业务逻辑校验，避免系统异常。

1. 适配渠道的参数校验：长度、类型、格式；
2. 订单的支付状态：是否支付；
3. 订单的有效期等等。

要点：

一般商户是不需要做支付路由，大部分都是指定了最终的某个支付渠道。

但也有些没有指定了某个最终的渠道，比如银行卡的支付可以选择哪个第三方支付来完成支付，还有微信线上线下的封装，这个时候就涉及到支付路由规则配置。

- 费率：单笔费率、总额费率、阶梯费率；
- 额度限制：单笔额度、时间范围内总额度；
- 服务指标：失败率、平均响应时间、异常率、TPS；
- 特殊配置：特殊要求（比如某渠道能快速结算）。

**支付网关的目的——省钱。**

### 支付风控

要点：梳理清楚业务风险，分析风险原因，制定风险防范规则。

#### 1. 数据来源
- 用（商）户信息
- 交易数据
- 账户数据
- 黑名单
- 设备、位置信息
- 日志数据

#### 2. 风控流程
事前：
- 入网审核
- 风险评估
- 单笔限额设置
- 单日限额设置
- 频次设置

事中：
- 实时分析
- 多维度判断
- 拒绝
- 拦截 – 进一步验证– 人工介入
- 延迟操作（例如用户大额提现，需要时间段进行复核）

事后：
- 数据分析
- 巡查、警告
- 降低评级
- 升级防范措施
- 逻辑完善
- 反馈至事前、事中规则中

### 账务系统
- 账务生成
- 内部对账
- 原始账单下载
- 生成标准账单
- 对账
- 差错处理

对账部分：
1. 获取核对文件；
2. 以账务系统为准来逐笔比对（以某个字段为准进行比对）；
3. 数据一致标记成功，数据不一致标记差错。

反向操作：
1. 以渠道账单为准来逐笔比对；
2. 数据一致标记成功，数据不一致标记差错。

### 差错处理
- 本地丢失：渠道账单的数据未在账务中查找到。
- 渠道丢失：账务中的数据未在渠道账单中查找到。
- 数据差错：账务与渠道某些对账字段未能对上。

**此处需要注意的是**，针对差错都需要向渠道查询每笔订单信息再次确认，同时，有些渠道的交易成功时间本来就是有错误的。一般来说是件不会差错很大，一般出现在跨日交易中，例如：当天交易无账单，先标记为差错，第二天再改正。

## 四、支付基础服务

TODO...


## 五、支付安全
### 数据安全
防窃听、防越权防抵赖、防破坏、防篡改、防重放、防泄漏。

**使用范围**：网络、系统、应用、业务等。

### 数据安全要点
- 加密通讯（防窃听）
- 双向签名（防抵赖、防篡改）
- 敏感数据加密存储（防泄漏）
- 密钥管理（通过认证接口获取，只允许加载到内存，不允许直接写入配置文件）
- 权限控制（防越权-非法访问）
- 数据的完整性（放篡改- 数据被恶意修改、非法篡改）

### 其他
- 内部接口认证。
- 避免内部代码未经审核发布到托管平台！！！
- 数据异常分析。
- 安全机构合作。

### 注意点
- 使用 HTTPS 加密传输；
- 传输的数据使用签名；
- 提交的数据是符合规则并且是不存在或者是未支付的；
- 支付成功以服务端异步通知为准。
